<%- contentFor('meta') %>
<title>Wishlist Index</title>

<%- contentFor('styles') %>

<%- contentFor('scripts') %>
<script>
  $(document).ready(function() {
    const setModal = function(html) {
      const $modal = $('#modal')
      const $modalContent = $modal.find('.modal-content')
      $modal.modal('show')
      $modalContent.html(html)
    }
    const setLoadingModal = function() {
      setModal(`
        <div class="modal-header">
          <h5 class="modal-title">Loading</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
        </div>
      `)
    }
    $('#tweets-index').on('click', '.show-btn, .edit-btn, #new-btn', function(e) {
      e.preventDefault()
      const $elem = $(e.target)
      const url = $elem.data('url')
      const method = $elem.data('method')
      setLoadingModal()
      axios({ method, url }).then(function(resp) {
        setModal(resp.data)
      })
    })
    $('#tweets-index').on('click', '.delete-btn', function(e) {
      e.preventDefault()
      const $elem = $(e.target)
      const url = $elem.data('url')
      $('#tweets-index .delete-btn').attr('disabled', true)
      axios({ method: 'DELETE', url }).then(function(resp) {
        $elem.parentsUntil('#tweets-list').remove()
      }).catch(function(err) {
        alert(err.response.data.message)
      }).then(function() {
        $('#tweets-index .delete-btn').attr('disabled', false)
      })
    })
    $('#modal').on('click', '#tweet-form-submit', function(e) {
      e.preventDefault()
      const $elem = $(e.target)
      const url = $elem.data('url')
      const method = $elem.data('method')
      const formData = new FormData($('#modal form')[0])
      $elem.attr('disabled', true)
      axios({ method, url, data: formData }).then(function(resp) {
        setModal(resp.data)
        if (method === 'POST') {
          const id = $('#modal').find('.modal-title span').text()
          $('#tweets-list').prepend(`
            <li class="my-1">
              <a class="show-btn font-weight-bold" data-url="/api/tweets/${id}" data-method="GET">${id}</a>
              <button class="edit-btn btn btn-info btn-sm" data-url="/api/tweets/${id}/edit" data-method="GET">Edit</button>
              <button class="delete-btn btn btn-danger btn-sm" data-url="/api/tweets/${id}">Delete</button>
            </li>
          `)
        }
      }).catch(function(err) {
        $elem.attr('disabled', false)
        const { response: { data: { errors } }} = err
        errors.forEach(function(error) {
          const { param: fieldName, msg } = error
          const $input = $('#modal').find(`[name="${fieldName}"]`)
          const $invalidFeedback = $input.siblings('.invalid-feedback')
          $input.addClass('is-invalid')
          $invalidFeedback.text(msg)
        })
      })
    })
  })
</script>



<%- contentFor('body') %>
<div class="container my-3 text-center">
  <h1 class="mb-3">Wishlists</h1>

  <a class="btn btn-success btn-sm" href="/wishlists/new">New</a>

  <% if (wishlists.length > 0) { %>
    <div class="mt-3">
      <form action="/wishlists" class="form-inline justify-content-center mb-3" method="GET">
        <div class="form-group mx-sm-3">
          <input type="text" class="form-control" placeholder="Search" name="q" value="<%= filters.q %> ">
        </div>
        <button type="submit" class="btn btn-primary mr-3">Search</button>
        <a href="/wishlists" class="btn btn-danger">Reset</a>
      </form>
    </div>

    <ul class="list-unstyled">
      <% wishlists.forEach(function(wishlist){ %>
        <li class="my-1">
          <a class="font-weight-bold" href="/wishlists/<%= wishlist.id %>"><%= wishlist.title %></a>
          <a class="btn btn-info btn-sm" href="/wishlists/<%= wishlist.id %>/edit"><i class="fas fa-edit"></i></a>
          <form class="d-inline" action="/wishlists/<%= wishlist.id %>?_method=DELETE" method="POST">
            <button class="btn btn-danger btn-sm" type="submit"><i class="fas fa-trash"></i></button>
          </form>
        </li>
        <% }) %>
    </ul>
<!-- origin: include("_partials/pagination") -->
  <%- include("../_partials/pagination") %>

  <% } else { %>
    <div>No Wishlists</div>
  <% } %>
</div>

<%- include('../_partials/modal') %>
